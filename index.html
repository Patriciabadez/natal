<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cartinha â€” Natal Encantado</title>
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{--bg1:#081226;--red:#c62828;--green:#197b30;--paper:#fffdf6;--accent:#f2c94c}
  *{box-sizing:border-box}body{margin:0;font-family:Poppins,Arial,Helvetica,sans-serif;background:linear-gradient(180deg,#02101b 0%,var(--bg1) 100%);color:#fff;padding:26px;min-height:100vh}
  .wrap{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:360px 1fr;gap:22px}
  header{grid-column:1/-1;display:flex;gap:12px;align-items:center}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--red),#ff6f61);display:flex;align-items:center;justify-content:center;font-size:22px}
  header h1{margin:0;font-size:20px}
  .panel{background:linear-gradient(180deg,#fff,#fffefb);padding:20px;border-radius:12px;color:#111}
  label{display:block;margin-top:10px;font-weight:600}
  input,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #eee}
  textarea{min-height:150px}
  .images-preview{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
  .thumb{width:80px;height:80px;border-radius:10px;overflow:hidden;border:2px solid rgba(0,0,0,0.06)}
  .controls{display:flex;gap:12px;margin-top:12px}
  button{padding:12px 16px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  #viewB{background:linear-gradient(180deg,var(--red),#b71c1c);color:#fff}
  button.secondary{background:linear-gradient(180deg,var(--green),#1b6b2b);color:#fff}
  #clearB{background:#777;color:#fff}

  /* overlay e neve */
  .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,20,0.85);z-index:900;visibility:hidden;opacity:0;transition:opacity .35s,visibility .35s;padding:18px}
  .overlay.is-active{visibility:visible;opacity:1}
  .snow{pointer-events:none;position:fixed;inset:0;z-index:999;overflow:hidden}
  .snow i{position:absolute;top:-10px;background:rgba(255,255,255,0.9);width:8px;height:8px;border-radius:50%;opacity:.8;animation:fall linear infinite;filter:blur(.3px)}
  @keyframes fall{to{transform:translateY(120vh)}}

  .card{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%) scale(.6);width:820px;max-width:96%;max-height:90vh;background:var(--paper);padding:34px;border-radius:14px;border:10px solid var(--red);box-shadow:0 30px 80px rgba(0,0,0,0.5);opacity:0;transition:all .6s .75s;overflow:auto;z-index:950;color:#111}
  .overlay.open .card{opacity:1;transform:translate(-50%,-50%) scale(1)}
  .paper-surface{background-image:radial-gradient(circle at 10% 10%, rgba(255,255,240,0.5) 1px, transparent 1px);padding:14px;border-radius:8px}
  .card header{display:flex;justify-content:space-between;align-items:flex-start;border-bottom:2px dashed rgba(0,0,0,0.06);padding-bottom:10px;margin-bottom:16px}
  .card h2{font-family:'Great Vibes',cursive;font-size:44px;margin:0;color:var(--red)}
  .message{font-size:18px;line-height:1.7;color:#222;white-space:pre-wrap}
  .gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-top:16px}
  .gi{height:140px;border-radius:10px;overflow:hidden}
  .gi img{width:100%;height:100%;object-fit:cover}

  .close{position:absolute;right:22px;top:18px;background:var(--red);color:#fff;border-radius:999px;width:46px;height:46px;border:0;cursor:pointer}

  @media(max-width:920px){.wrap{grid-template-columns:1fr}.card{padding:20px}.card h2{font-size:32px}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">ðŸŽ„</div>
    <div>
      <h1>Cartinha â€” Natal Encantado</h1>
      <div class="sub">IlustraÃ§Ãµes, neve animada e cores vibrantes.</div>
    </div>
  </header>

  <section class="panel">
    <label for="nameB">Seu nome</label>
    <input id="nameB" placeholder="Ex: Ana" />
    <label for="fromB">De (opcional)</label>
    <input id="fromB" placeholder="Ex: FamÃ­lia" />
    <label for="toB">Para (opcional)</label>
    <input id="toB" placeholder="Ex: Pedro" />
    <label for="msgB">Mensagem / Carta</label>
    <textarea id="msgB">Que o espÃ­rito natalino traga alegria e luz. Boas festas!</textarea>
    <label for="photosB">Fotos (atÃ© 10)</label>
    <input id="photosB" type="file" accept="image/*" multiple />
    <div class="images-preview" id="thumbsB"></div>
    <div class="controls"><button id="viewB">Visualizar âœ¨</button><button id="clearB">Limpar</button></div>
  </section>

  <div class="overlay" id="overlayB" aria-hidden="true">
    <!-- neve -->
    <div class="snow" id="snowB"></div>
    <button class="close" id="closeB">âœ•</button>

    <div class="card" id="cardB" role="dialog" aria-modal="true">
      <div class="paper-surface" id="contentB"></div>
      <div style="display:flex;gap:12px;justify-content:center;margin-top:18px">
        <button id="pdfB" class="secondary">Gerar PDF</button>
        <button id="htmlB" class="secondary">Download HTML</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  const nameB = document.getElementById('nameB'), fromB = document.getElementById('fromB'), toB = document.getElementById('toB'),
        msgB = document.getElementById('msgB'), photosB = document.getElementById('photosB'), thumbsB = document.getElementById('thumbsB');
  const overlay = document.getElementById('overlayB'), content = document.getElementById('contentB'), snow = document.getElementById('snowB');
  const view = document.getElementById('viewB'), close = document.getElementById('closeB'), pdfBtn = document.getElementById('pdfB'), htmlBtn = document.getElementById('htmlB'), clearBtn = document.getElementById('clearB');
  let imgsB = [];

  photosB.addEventListener('change', e=> readFiles(e.target.files, imgsB, thumbsB));
  document.body.addEventListener('dragover', e=> e.preventDefault());
  document.body.addEventListener('drop', e=> { e.preventDefault(); if(e.dataTransfer.files) readFiles(e.dataTransfer.files, imgsB, thumbsB); });

  function readFiles(list, arr, thumbsEl){ const f = Array.from(list).slice(0,10); arr.splice(0); thumbsEl.innerHTML=''; f.forEach(file=>{ const r=new FileReader(); r.onload=e=>{ arr.push(e.target.result); const d=document.createElement('div'); d.className='thumb'; const i=document.createElement('img'); i.src=e.target.result; d.appendChild(i); thumbsEl.appendChild(d); }; r.readAsDataURL(file); }); }

  function generateHTML(){
    const n = (nameB.value||'Amigo(a)').trim(), fr=(fromB.value||n).trim(), t=(toB.value||'').trim(), m=(msgB.value||'Boas festas!').trim();
    const title = t ? `Para meu querido(a) ${t}` : 'Feliz Natal!';
    const meta = n;
    let gallery='';
    if(imgsB.length===0) gallery = `<div style="padding:20px;border-radius:8px;background:#fffdef;border:1px dashed #ffeabb;color:#b87f28;text-align:center">Nenhuma imagem adicionada.</div>`;
    else imgsB.slice(0,10).forEach(u=> gallery += `<div class="gi"><img src="${u}"></div>`);
    const month = new Date().toLocaleString('pt-BR',{month:'long',year:'numeric'});
    return `
      <header style="display:flex;justify-content:space-between;align-items:flex-start;border-bottom:2px dashed rgba(0,0,0,0.06);padding-bottom:10px;margin-bottom:14px">
        <div><h2 style="font-family: 'Great Vibes', cursive;font-size:42px;margin:0;color:var(--red)">${title}</h2><div style="color:#333;margin-top:6px">${meta}</div></div>
        <div style="text-align:right;color:#333">ðŸŽ„ ${month}</div>
      </header>
      <div style="font-size:18px;line-height:1.7;color:#222;white-space:pre-wrap">${escapeHtml(m)}</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-top:16px">${gallery}</div>
      <div style="margin-top:18px;padding-top:14px;border-top:1px dotted #ccc;color:#444">Com carinho,<br><strong>${escapeHtml(fr)}</strong></div>
    `;
  }

  function escapeHtml(t){ return t.replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

  function startSnow(){
    snow.innerHTML=''; const count = 40;
    for(let i=0;i<count;i++){
      const s = document.createElement('i'); s.style.left = Math.random()*100+'%'; s.style.width = (3+Math.random()*8)+'px'; s.style.height = s.style.width; s.style.opacity = (0.4+Math.random()*0.8); s.style.animationDuration = (6+Math.random()*8)+'s'; s.style.animationDelay = (Math.random()*4)+'s';
      snow.appendChild(s);
    }
  }

  view.addEventListener('click', ()=>{ content.innerHTML = generateHTML(); startSnow(); overlay.classList.add('is-active'); setTimeout(()=> overlay.classList.add('open'),60); });
  close.addEventListener('click', ()=>{ overlay.classList.remove('open'); setTimeout(()=> overlay.classList.remove('is-active'),700); });
  overlay.addEventListener('click', e=> { if(e.target===overlay) { overlay.classList.remove('open'); setTimeout(()=> overlay.classList.remove('is-active'),700); }});
  clearBtn.addEventListener('click', ()=>{ nameB.value=''; fromB.value=''; toB.value=''; msgB.value=''; imgsB=[]; thumbsB.innerHTML=''; photosB.value=null; });

  pdfBtn.addEventListener('click', async ()=>{
    content.innerHTML = generateHTML();
    const clone = document.getElementById('cardB').cloneNode(true);
    const ab = clone.querySelector('div[style*="display:flex"]'); if(ab) ab.remove();
    clone.style.position='absolute'; clone.style.left='-9999px'; clone.style.top='-9999px'; clone.style.transform='none'; clone.style.opacity='1'; clone.style.boxShadow='none'; clone.style.border='none'; clone.style.width='820px';
    document.body.appendChild(clone);
    try{
      const canvas = await html2canvas(clone, {scale:2, useCORS:true, backgroundColor:null});
      const img = canvas.toDataURL('image/jpeg',0.95);
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({unit:'pt',format:'a4'});
      const w = pdf.internal.pageSize.getWidth(), h = pdf.internal.pageSize.getHeight();
      const pxW = canvas.width, pxH = canvas.height;
      const ratio = Math.min(w/pxW, h/pxH);
      const imgW = pxW*ratio, imgH = pxH*ratio;
      if(imgH <= h-40) pdf.addImage(img,'JPEG',(w-imgW)/2,20,imgW,imgH);
      else {
        const pageCanvas = document.createElement('canvas'), ctx = pageCanvas.getContext('2d');
        pageCanvas.width = pxW; pageCanvas.height = Math.floor((h-40)/ratio);
        let y=0; let rem=pxH; let page=0;
        while(rem>0){
          ctx.clearRect(0,0,pageCanvas.width,pageCanvas.height);
          ctx.drawImage(canvas,0,y,pageCanvas.width,pageCanvas.height,0,0,pageCanvas.width,pageCanvas.height);
          const part = pageCanvas.toDataURL('image/jpeg',0.95);
          if(page>0) pdf.addPage();
          pdf.addImage(part,'JPEG',(w-imgW)/2,20,imgW,pageCanvas.height*ratio);
          y+=pageCanvas.height; rem-=pageCanvas.height; page++;
        }
      }
      const safe = (nameB.value.trim()||'cartinha').replace(/[^a-z0-9_-]/gi,'_');
      pdf.save(`${safe}_encantado.pdf`);
    }catch(err){console.error(err);alert('Erro ao gerar PDF');}
    finally{ document.body.removeChild(clone); }
  });

  htmlBtn.addEventListener('click', ()=>{
    const inner = generateHTML();
    const full = `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Cartinha Encantada</title><link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet"><style>body{font-family:Poppins,Arial,sans-serif;background:#f7fbff;padding:28px}.main{max-width:820px;margin:0 auto;padding:34px;border-radius:12px;background:${getComputedStyle(document.documentElement).getPropertyValue('--paper')||'#fffdf6'};border:10px solid ${getComputedStyle(document.documentElement).getPropertyValue('--red')||'#c62828'}}</style></head><body><div class="main">${inner}</div></body></html>`;
    const blob = new Blob([full],{type:'text/html'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=(nameB.value.trim()||'cartinha')+'_encantado.html'; a.click(); URL.revokeObjectURL(url);
  });
</script>
</body>
</html>
